<!DOCTYPE html>
<html lang="kr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/mainlayout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>콘텐츠 등록/수정</title>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<main layout:fragment="content">
    <!--    <h1>Welcome to the Dashboard</h1>-->
    <!--    <p>This is your main content area.</p>-->

    <div class="container mt-5">
        <h2>크레딧 등록/수정</h2>

        <form th:action="@{/content/{contentId}/credit(contentId=${contentId})}" method="post">
            <!-- 수정할 크레딧 정보 전송 -->
            <input type="hidden" name="id" th:value="${creditDTO.id}"/>
            <input type="hidden" name="person.id"
                   th:value="${creditDTO.person != null ? creditDTO.person.id : ''}"/>

            <div class="mb-3">
                <label class="form-label">선택된 인물</label>
                <div class="input-group">
                    <input type="text" class="form-control" name="person.name"
                           th:value="${creditDTO.person?.name}" readonly required/>
                    <button type="button" class="btn btn-outline-primary"
                            data-bs-toggle="modal" data-bs-target="#personModal">
                        🔍 인물 검색
                    </button>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">부서</label>
                <input type="text" class="form-control" name="department"
                       th:value="${creditDTO.department}" required/>
            </div>

            <div class="mb-3">
                <label class="form-label">역할</label>
                <input type="text" class="form-control" name="role"
                       th:value="${creditDTO.role}" required/>
            </div>

            <div class="mb-3">
                <label class="form-label">캐릭터 이름</label>
                <input type="text" class="form-control" name="characterName"
                       th:value="${creditDTO.characterName}"/>
            </div>

            <!-- 제출 및 목록 버튼 -->
            <button type="submit" class="btn btn-primary">저장</button>
            <a th:href="@{'/content/' + ${contentId} + '/credit'}" class="btn btn-secondary">목록</a>
            <a th:href="@{'/content/' + ${contentId} + '/gallery'}" class="btn btn-success mt-3">📂 갤러리 등록/수정</a>
        </form>
        <!-- form 종료 -->

        <!-- 인물 검색 모달 -->
        <div class="modal fade" id="personModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">인물 검색</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group mb-3">
                            <input type="text" id="personSearchInput" class="form-control" placeholder="인물 이름 입력">
                            <button class="btn btn-primary" id="personSearchBtn">검색</button>
                        </div>
                        <div class="row" id="personResults"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 등록된 크레딧 목록 -->
        <table class="table table-bordered mt-3">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>인물 이름</th>
                <th>부서</th>
                <th>역할</th>
                <th>캐릭터 이름</th>
                <th>작업선택</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="credit : ${creditList}">
                <td th:text="${credit.id}">1</td>
                <td th:text="${credit.person?.name}">인물</td>
                <td th:text="${credit.department}">부서</td>
                <td th:text="${credit.role}">역할</td>
                <td th:text="${credit.characterName}">캐릭터</td>
                <td>
                    <a th:href="@{'/content/' + ${contentId} + '/credit?id=' + ${credit.id}}"
                       class="btn btn-sm btn-warning">✏ 수정</a>
                    <form th:action="@{'/content/' + ${contentId} + '/credit/delete'}"
                          method="post" style="display:inline;">
                        <input type="hidden" name="creditId" th:value="${credit.id}"/>
                        <button type="submit" class="btn btn-sm btn-danger">🗑 삭제</button>
                    </form>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(creditList)}">
                <td colspan="6" class="text-center">등록된 크레딧이 없습니다.</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 모달 선택 JS -->
    <script>
        function selectPerson(id, name) {
            // 부모 폼 input에 값 전달
            // 인물 선택 시, 신규 등록 모드로 전환
            document.querySelector('input[name="id"]').value = ""; // 기존 creditId 초기화
            document.querySelector('input[name="person.id"]').value = id;
            document.querySelector('input[name="person.name"]').value = name;

            // 2. 모달 닫기 및 완전 종료(dispose)
            const modalElement = document.getElementById('personModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
                modal.dispose(); // 🔹 완전 해제
            }

            // 3. 혹시 남아있는 backdrop 강제 제거
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

            // 4. 검색창 초기화 (다음 검색 시 깔끔하게)
            document.getElementById('personSearchInput').value = '';
            document.getElementById('personResults').innerHTML = '';

            // 5. 🔹 credit.html 입력란 활성화 (부서에 자동 포커스)
            setTimeout(() => {
                const deptInput = document.querySelector('input[name="department"]');
                if (deptInput) {
                    deptInput.removeAttribute('disabled'); // 혹시 disabled 걸려있으면 해제
                    deptInput.focus();
                }
            }, 100);
        }

        document.getElementById('personSearchBtn').addEventListener('click', function () {
                const keyword = document.getElementById('personSearchInput').value.trim();
                if (!keyword) { alert("검색어를 입력해주세요."); return; }

                const contentId = '[[${contentId}]]'; // 문자열 처리
                fetch(`/content/${contentId}/credit/search-person?keyword=${encodeURIComponent(keyword)}`)
                    .then(res => res.json())
                    .then(data => {
                        const results = document.getElementById('personResults');
                        if (data.length === 0) {
                            results.innerHTML = `<p class="text-muted">검색 결과 없음</p>`;
                            return;
                        }
                        results.innerHTML = data.map(person => `
                            <div class="col-md-4">
                              <div class="card mb-3">
                                <img src="${person.profile || '/images/default-profile.png'}"
                                     class="card-img-top" style="height:180px; object-fit:cover;">
                                <div class="card-body">
                                  <h5 class="card-title">${person.name}</h5>
                                  <p class="card-text"><small>${person.job}</small></p>
                                  <button type="button" class="btn btn-success btn-sm"
                                          onclick="selectPerson('${person.id}', '${person.name}')">선택</button>
                                </div>
                              </div>
                            </div>`).join('');
                });
        });
    </script>

</main>
</body>
</html>

